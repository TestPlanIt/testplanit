# Release Workflow
#
# This workflow handles creating GitHub releases and building Docker images.
#
# Triggers:
# 1. Tag Push (automatic): Pushing a tag like `v1.0.0` triggers both release creation and Docker builds
# 2. Manual Dispatch: Manually trigger Docker builds for any existing tag via GitHub Actions UI
#
# Docker Images Built:
# - Production image: ghcr.io/testplanit/testplanit:latest (for Next.js server)
# - Workers image: ghcr.io/testplanit/testplanit:latest-workers (for background workers)
#
# IMPORTANT: Docker images are built with BASE_DOMAIN=testplanit.com which enables a wildcard
# pattern (*.testplanit.com) for Next.js image optimization. This allows a SINGLE Docker image
# to serve ALL customer subdomains (e.g., company1.testplanit.com, company2.testplanit.com, etc.)
# without needing to rebuild for each customer.
#
# Manual Trigger Instructions:
# 1. Go to Actions tab in GitHub
# 2. Select "Release" workflow
# 3. Click "Run workflow"
# 4. Enter the tag name (e.g., v1.0.0)
# 5. Click "Run workflow" button
#
name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: [self-hosted, linux]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set lowercase repo name
      run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Verify GitHub CLI
      run: |
        # Ensure we're using the official gh CLI (not npm package)
        /usr/bin/gh --version

    - name: Create Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        /usr/bin/gh release create "${{ github.ref_name }}" \
          --title "Release ${{ github.ref_name }}" \
          --notes "## What's Changed

        See [CHANGELOG.md](https://github.com/${REPO_LC}/blob/main/testplanit/CHANGELOG.md) for details.

        ## Docker Images

        Production image:
        \`\`\`bash
        docker pull ghcr.io/${REPO_LC}:${{ github.ref_name }}
        \`\`\`

        Workers image:
        \`\`\`bash
        docker pull ghcr.io/${REPO_LC}:${{ github.ref_name }}-workers
        \`\`\`"

  # Build AMD64 images natively on x64 runner
  build-amd64:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: create-release
    runs-on: [self-hosted, linux, x64]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set lowercase repo name
      run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate version info for Docker build
      run: |
        cd testplanit
        node scripts/generate-version.js
        mkdir -p public
        cp public/version.json .docker-version.json || echo "Version file not generated"

    - name: Build and push AMD64 images
      working-directory: ./testplanit
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"

        docker buildx bake -f docker-bake.hcl --push \
          --set "*.platform=linux/amd64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${VERSION_NUM}-amd64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${VERSION}-amd64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${VERSION_NUM}-workers-amd64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${VERSION}-workers-amd64" \
          --set "*.args.VERSION=${VERSION}" \
          --set "*.args.GIT_COMMIT=${{ github.sha }}" \
          --set "*.args.BASE_DOMAIN=testplanit.com"

  # Build ARM64 images natively on macOS arm64 runner (using Colima)
  build-arm64:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: create-release
    runs-on: [self-hosted, macOS, arm64]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set lowercase repo name
      run: echo "REPO_LC=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

    - name: Start Colima
      run: |
        if ! colima status 2>/dev/null; then
          colima start --cpu 6 --memory 24
        fi
        docker context use colima

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate version info for Docker build
      run: |
        cd testplanit
        node scripts/generate-version.js
        mkdir -p public
        cp public/version.json .docker-version.json || echo "Version file not generated"

    - name: Build and push ARM64 images
      working-directory: ./testplanit
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"

        docker buildx bake -f docker-bake.hcl --push \
          --set "*.platform=linux/arm64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${VERSION_NUM}-arm64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${VERSION}-arm64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${VERSION_NUM}-workers-arm64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${VERSION}-workers-arm64" \
          --set "*.args.VERSION=${VERSION}" \
          --set "*.args.GIT_COMMIT=${{ github.sha }}" \
          --set "*.args.BASE_DOMAIN=testplanit.com"

  # Merge architecture-specific images into multi-arch manifests
  merge-manifests:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: [build-amd64, build-arm64]
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to get all tags

    - name: Set lowercase repo name
      run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create multi-arch manifests
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"

        # Create production manifests
        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION_NUM} \
          ghcr.io/${REPO_LC}:${VERSION_NUM}-amd64 \
          ghcr.io/${REPO_LC}:${VERSION_NUM}-arm64

        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION} \
          ghcr.io/${REPO_LC}:${VERSION}-amd64 \
          ghcr.io/${REPO_LC}:${VERSION}-arm64

        # Create workers manifests
        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION_NUM}-workers \
          ghcr.io/${REPO_LC}:${VERSION_NUM}-workers-amd64 \
          ghcr.io/${REPO_LC}:${VERSION_NUM}-workers-arm64

        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION}-workers \
          ghcr.io/${REPO_LC}:${VERSION}-workers-amd64 \
          ghcr.io/${REPO_LC}:${VERSION}-workers-arm64

        # Only update 'latest' if this is the newest semantic version
        LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -n1)
        if [ "$VERSION" = "$LATEST_TAG" ]; then
          echo "Updating 'latest' tags to $VERSION"
          docker buildx imagetools create -t ghcr.io/${REPO_LC}:latest \
            ghcr.io/${REPO_LC}:${VERSION}-amd64 \
            ghcr.io/${REPO_LC}:${VERSION}-arm64

          docker buildx imagetools create -t ghcr.io/${REPO_LC}:latest-workers \
            ghcr.io/${REPO_LC}:${VERSION}-workers-amd64 \
            ghcr.io/${REPO_LC}:${VERSION}-workers-arm64
        else
          echo "Skipping 'latest' update - $VERSION is not the latest release (latest: $LATEST_TAG)"
        fi

  # Manual build: AMD64 images natively on x64 runner
  docker-manual-amd64:
    if: github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, linux, x64]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag }}

    - name: Set lowercase repo name
      run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate version info for Docker build
      run: |
        cd testplanit
        node scripts/generate-version.js
        mkdir -p public
        cp public/version.json .docker-version.json || echo "Version file not generated"

    - name: Build and push AMD64 images
      working-directory: ./testplanit
      run: |
        docker buildx bake -f docker-bake.hcl --push \
          --set "*.platform=linux/amd64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${{ github.event.inputs.tag }}-amd64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${{ github.event.inputs.tag }}-workers-amd64" \
          --set "*.args.VERSION=${{ github.event.inputs.tag }}" \
          --set "*.args.GIT_COMMIT=${{ github.sha }}" \
          --set "*.args.BASE_DOMAIN=testplanit.com"

  # Manual build: ARM64 images natively on macOS arm64 runner (using Colima)
  docker-manual-arm64:
    if: github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, macOS, arm64]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.tag }}

    - name: Set lowercase repo name
      run: echo "REPO_LC=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

    - name: Start Colima
      run: |
        if ! colima status 2>/dev/null; then
          colima start --cpu 6 --memory 24
        fi
        docker context use colima

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate version info for Docker build
      run: |
        cd testplanit
        node scripts/generate-version.js
        mkdir -p public
        cp public/version.json .docker-version.json || echo "Version file not generated"

    - name: Build and push ARM64 images
      working-directory: ./testplanit
      run: |
        docker buildx bake -f docker-bake.hcl --push \
          --set "*.platform=linux/arm64" \
          --set "production.tags=ghcr.io/${REPO_LC}:${{ github.event.inputs.tag }}-arm64" \
          --set "workers.tags=ghcr.io/${REPO_LC}:${{ github.event.inputs.tag }}-workers-arm64" \
          --set "*.args.VERSION=${{ github.event.inputs.tag }}" \
          --set "*.args.GIT_COMMIT=${{ github.sha }}" \
          --set "*.args.BASE_DOMAIN=testplanit.com"

  # Manual build: Merge architecture-specific images into multi-arch manifests
  docker-manual-merge:
    if: github.event_name == 'workflow_dispatch'
    needs: [docker-manual-amd64, docker-manual-arm64]
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Set lowercase repo name
      run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create multi-arch manifests
      run: |
        VERSION="${{ github.event.inputs.tag }}"

        # Create production manifest
        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION} \
          ghcr.io/${REPO_LC}:${VERSION}-amd64 \
          ghcr.io/${REPO_LC}:${VERSION}-arm64

        # Create workers manifest
        docker buildx imagetools create -t ghcr.io/${REPO_LC}:${VERSION}-workers \
          ghcr.io/${REPO_LC}:${VERSION}-workers-amd64 \
          ghcr.io/${REPO_LC}:${VERSION}-workers-arm64