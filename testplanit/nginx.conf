events {
    worker_connections 1024;
}

http {
    upstream testplanit_app {
        server prod:3000;
    }

    upstream testplanit_minio {
        server minio:9000;
    }

    server {
        listen 80;
        server_name _;

        # Maintenance mode - returns 503 if /etc/nginx/maintenance.json exists
        error_page 503 @maintenance;

        location @maintenance {
            root /etc/nginx;
            rewrite ^(.*)$ /maintenance.html break;
        }

        # Serve maintenance config file
        location = /maintenance.json {
            root /etc/nginx;
            add_header Content-Type application/json;
        }

        # Check for maintenance mode file
        set $maintenance 0;
        if (-f /etc/nginx/maintenance.json) {
            set $maintenance 1;
        }

        # Allow health checks during maintenance
        location = /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Proxy MinIO requests (bucket operations)
        location /testplanit/ {
            proxy_pass http://testplanit_minio/testplanit/;
            # Forward original host header unchanged for AWS signature validation
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_request_buffering off;
            
            # MinIO specific headers for S3 API compatibility
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            
            # Increase client body size for file uploads
            client_max_body_size 100M;
            
            # Handle CORS for file uploads
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";
            
            # Handle preflight requests
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Headers "Content-Type, Authorization";
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }
        
        # Keep old MinIO path for compatibility
        location /minio/ {
            proxy_pass http://testplanit_minio/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 100M;
        }

        # Proxy all other requests to TestPlanIt app
        location / {
            # Return 503 if in maintenance mode
            if ($maintenance = 1) {
                return 503;
            }

            proxy_pass http://testplanit_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Important for OAuth callbacks and cookies
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
            
            # Disable buffering for real-time responses
            proxy_buffering off;
            proxy_request_buffering off;
            
            # Increase buffer sizes for OAuth POST callbacks
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
            
            # Increase timeouts for OAuth operations
            proxy_connect_timeout 90s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
            
            # Handle large POST bodies from Apple Sign In
            client_max_body_size 10M;
            client_body_buffer_size 128k;
        }
    }
}